<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet"/type="text/css" href="./css/participants.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.6.0/d3.js"></script>
    <script src="./js/participants.js"></script>
</head>
<body>

    <button id="participants-change-data" onclick="changeDataParticipants()">4+ Competitions</button>
    <div id="participants-chart"><svg></svg></div>

    <script>
        console.log('participants story');

        d3.csv('./data/participants3.csv', function(error, data) {
            if (error) {
                console.error('Error getting or parsing the data.');
                throw error;
            }
            // selection.datum() returns the bound datum for the first element in the selection and
            //  doesn't join the specified array of data with the selected elements
            var chart = participantsBubbleChart().width(1200).height(800);
            d3.select('#participants-chart').datum(data).call(chart);
        });
        var participationsNumber = 4,
        increaseParticipationsNumber = true;
        function changeDataParticipants(){

            d3.csv('participants3.csv', function(error, data) {
                if (error) {
                    console.error('Error getting or parsing the data.');
                    throw error;
                }
                //on ne garde que les donnÃ©es pour lesquels la participation est sup a number
                var filteredDataParticipants = data.filter(function(d){
                    return d.Participations > participationsNumber ;
                });
                if((increaseParticipationsNumber && participationsNumber < 10)||(!increaseParticipationsNumber && participationsNumber < 4)){
                    increaseParticipationsNumber = true;
                    participationsNumber += 1;
                }
                else {
                    increaseParticipationsNumber = false;
                    participationsNumber -= 1;
                }
                //Replace value in the button
                document.getElementById("participants-change-data").innerHTML = parseInt(participationsNumber) + '+ Competitons';

                //TODO: match case for strength
                if(!increaseParticipationsNumber){
                    // console.log("test")
                    var chart = bubbleChart().width(1600).height(1000);
                    d3.select('#participants-chart').datum(filteredDataParticipants).call(chart);
                }

                //rejoin data
                var circle = d3.select('#participants-chart').selectAll("circle")
                .data(filteredDataParticipants);

                if(increaseParticipationsNumber) {
                    circle.exit().remove();//remove unneeded circles
                }

                var force = -10;
                d3.forceSimulation(filteredDataParticipants)
                .force("charge", d3.forceManyBody().strength([force]))
                .force("x", d3.forceX())
                .force("y", d3.forceY());
            });
        }

    </script>
</body>
</html>
